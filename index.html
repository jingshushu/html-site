<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>flomoæ‹†åˆ†æ’ä»¶</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary: #30cf79; --bg: #f4f7f6; --danger: #ff4d4f; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #333; line-height: 1.6; max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); }
        h1 { color: var(--primary); margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .section { border-bottom: 1px solid #eee; padding: 20px 0; }
        label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: #666; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:hover { background: #28ad65; }
        
        /* é¢„è§ˆè¡¨æ ¼æ ·å¼ */
        .preview-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .preview-table th, .preview-table td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .preview-table th { background: #fafafa; }
        .warning-row { color: var(--danger); font-weight: bold; background: #fff1f0; }
        .info-bar { background: #eefaf3; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .tag { font-size: 12px; background: #eee; padding: 2px 6px; border-radius: 4px; color: #666; }
    </style>
</head>
<body>

<div class="card">
    <h1>flomoå¢å¼ºÂ·å¯¼å‡ºHTMLè½¬Markdown v3</h1>

    <div class="section">
        <label>1. ä¸Šä¼  flomo å¯¼å‡ºçš„ HTML</label>
        <input type="file" id="htmlFile" accept=".html">
    </div>

    <div id="configArea" style="display: none;">
        <div class="info-bar">
            <div id="userInfo"></div>
            <div id="dateSpan" style="font-size: 13px; color: #666;"></div>
        </div>

        <div class="section">
            <label>2. å¯¼å‡ºè®¾ç½®</label>
            <div class="grid">
                <input type="date" id="startDate">
                <input type="date" id="endDate">
            </div>
            <div class="grid" style="grid-template-columns: 1fr 2fr; margin-top: 15px;">
                <select id="splitRange">
                    <option value="year">æŒ‰å¹´æ‹†åˆ†</option>
                    <option value="halfYear">æŒ‰åŠå¹´æ‹†åˆ†</option>
                    <option value="quarter">æŒ‰å­£åº¦æ‹†åˆ†</option>
                    <option value="month" selected>æŒ‰æœˆä»½æ‹†åˆ†</option>
                </select>
                <input type="text" id="nameTemplate" placeholder="æ–‡ä»¶åæ¨¡æ¿">
            </div>
        </div>

        <div class="section">
            <label>3. å¯¼å‡ºé¢„è§ˆ (é¢„ä¼°å­—æ•°)</label>
            <div id="previewContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                <table class="preview-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>å¾…ç”Ÿæˆæ–‡ä»¶å</th>
                            <th>ç¬”è®°æ¡æ•°</th>
                            <th>é¢„ä¼°æ€»å­—æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
        </div>

        <button id="processBtn">ç¡®è®¤å¹¶å¯¼å‡ºå‹ç¼©åŒ…</button>
    </div>

    <div id="status" style="margin-top: 20px; font-size: 14px; color: #888;">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
</div>

<script>
    let allMemos = [];
    let detectedUser = "flomo";
    const WORD_LIMIT = 500000; // 50ä¸‡å­—é™åˆ¶
    
    const fileInput = document.getElementById('htmlFile');
    const configArea = document.getElementById('configArea');
    const previewBody = document.getElementById('previewBody');
    const statusDiv = document.getElementById('status');

    // æ ¸å¿ƒ UI æ›´æ–°é€»è¾‘
    const updatePreview = () => {
        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        end.setHours(23, 59, 59);
        const rangeType = document.getElementById('splitRange').value;
        const template = document.getElementById('nameTemplate').value;

        const filtered = allMemos.filter(m => m.timestamp >= start && m.timestamp <= end);
        const groups = {};

        filtered.forEach(m => {
            const rangeSuffix = getRangeSuffix(m.timestamp, rangeType);
            const fileName = template.replace('{{user}}', detectedUser).replace('{{range}}', rangeSuffix).replace('{{date}}', "").trim() + ".md";
            
            if (!groups[fileName]) groups[fileName] = { count: 0, words: 0 };
            groups[fileName].count += 1;
            groups[fileName].words += m.plainText.length;
        });

        previewBody.innerHTML = "";
        let hasOverflow = false;

        Object.keys(groups).sort().forEach(name => {
            const row = document.createElement('tr');
            const info = groups[name];
            if (info.words > WORD_LIMIT) {
                row.className = 'warning-row';
                hasOverflow = true;
            }
            row.innerHTML = `<td>${name}</td><td>${info.count} æ¡</td><td>${info.words.toLocaleString()} å­— ${info.words > WORD_LIMIT ? 'âš ï¸ è¿‡å¤§' : ''}</td>`;
            previewBody.appendChild(row);
        });

        return hasOverflow;
    };

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(event.target.result, 'text/html');
            const nameElem = doc.querySelector('.user .name');
            detectedUser = nameElem ? nameElem.innerText.replace('@', '') : "flomoç”¨æˆ·";
            
            const memoNodes = doc.querySelectorAll('.memo');
            allMemos = Array.from(memoNodes).map(node => {
                const content = node.querySelector('.content').innerHTML;
                return {
                    time: node.querySelector('.time').innerText,
                    timestamp: new Date(node.querySelector('.time').innerText.replace(/-/g, '/')),
                    content: content,
                    plainText: node.querySelector('.content').innerText // ç”¨äºå­—æ•°ç»Ÿè®¡
                };
            });

            allMemos.sort((a, b) => a.timestamp - b.timestamp);
            
            document.getElementById('userInfo').innerHTML = `ğŸ‘¤ ç”¨æˆ·: <strong>${detectedUser}</strong> | å…± <strong>${allMemos.length}</strong> æ¡ç¬”è®°`;
            const first = allMemos[0].time.split(' ')[0];
            const last = allMemos[allMemos.length-1].time.split(' ')[0];
            document.getElementById('dateSpan').innerText = `ğŸ“… æ—¶é—´è·¨åº¦: ${first} è‡³ ${last}`;
            
            document.getElementById('startDate').value = first;
            document.getElementById('endDate').value = last;
            document.getElementById('nameTemplate').value = `{{user}}_{{range}}`;
            
            configArea.style.display = 'block';
            statusDiv.innerText = "è§£æå®Œæˆã€‚";
            updatePreview();
        };
        reader.readAsText(file);
    });

    // ç›‘å¬è®¾ç½®å˜åŒ–å®æ—¶æ›´æ–°é¢„è§ˆ
    ['startDate', 'endDate', 'splitRange', 'nameTemplate'].forEach(id => {
        document.getElementById(id).addEventListener('change', updatePreview);
        document.getElementById(id).addEventListener('input', updatePreview);
    });

    function getRangeSuffix(date, rangeType) {
        const y = date.getFullYear();
        const m = date.getMonth() + 1;
        if (rangeType === 'year') return `${y}å¹´`;
        if (rangeType === 'month') return `${y}-${m.toString().padStart(2, '0')}`;
        if (rangeType === 'quarter') return `${y}-Q${Math.ceil(m/3)}`;
        if (rangeType === 'halfYear') return m <= 6 ? `${y}-ä¸ŠåŠå¹´` : `${y}-ä¸‹åŠå¹´`;
        return 'export';
    }

    function htmlToMd(html) {
        return html.replace(/<p>(.*?)<\/p>/gi, '$1\n\n')
                   .replace(/<li>(.*?)<\/li>/gi, '- $1\n')
                   .replace(/<(?:.|\n)*?>/gm, '').trim();
    }

    document.getElementById('processBtn').addEventListener('click', async () => {
        if (updatePreview()) {
            if (!confirm("æ£€æµ‹åˆ°éƒ¨åˆ†æ–‡ä»¶å­—æ•°è¶…è¿‡ 50 ä¸‡å­—ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¬”è®°è½¯ä»¶è¿è¡Œç¼“æ…¢ï¼Œæ˜¯å¦åšæŒå¯¼å‡ºï¼Ÿ")) {
                return;
            }
        }

        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        end.setHours(23, 59, 59);
        const rangeType = document.getElementById('splitRange').value;
        const template = document.getElementById('nameTemplate').value;

        const filtered = allMemos.filter(m => m.timestamp >= start && m.timestamp <= end);
        const zip = new JSZip();
        const files = {};

        filtered.forEach(m => {
            const rangeSuffix = getRangeSuffix(m.timestamp, rangeType);
            const fileName = template.replace('{{user}}', detectedUser).replace('{{range}}', rangeSuffix).trim() + ".md";
            if (!files[fileName]) files[fileName] = "";
            files[fileName] += `### ${m.time}\n\n${htmlToMd(m.content)}\n\n---\n\n`;
        });

        for (const name in files) zip.file(name, files[name]);

        const blob = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `flomo_${detectedUser}_export.zip`;
        link.click();
    });
</script>
</body>
</html>
