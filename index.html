<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPT è½¬ å°çº¢ä¹¦å°é¢ (æœ€ç»ˆä¸“ä¸šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        [v-cloak] { display: none; }
        
        /* æ»šåŠ¨æ¡ç»†åŒ– */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        /* å¯¼å‡ºæ—¶éšè—è™šçº¿è¾¹æ¡†çš„å…³é”®æ ·å¼ */
        .exporting .drop-zone { border: none !important; background: transparent !important; }
        .exporting .slot-number { display: none !important; }
        .exporting .delete-btn { display: none !important; }

        /* æ‚¬åœæ”¾å¤§é¢„è§ˆåŠ¨ç”» */
        .zoom-preview {
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            transition: opacity 0.2s;
        }
    </style>
</head>
<body class="bg-gray-900 h-screen overflow-hidden text-gray-200">

<div id="app" v-cloak class="flex h-full">

    <div v-if="hoverImage" class="zoom-preview fixed bottom-4 left-4 border-2 border-indigo-500 bg-gray-800 rounded-lg p-1 w-64 aspect-video">
        <img :src="hoverImage" class="w-full h-full object-contain">
        <div class="absolute top-0 right-0 bg-indigo-600 text-white text-xs px-2 py-0.5">é¢„è§ˆ</div>
    </div>

    <div class="w-[400px] bg-gray-800 border-r border-gray-700 flex flex-col h-full shadow-xl z-20 flex-shrink-0">
        
        <div class="p-4 border-b border-gray-700 bg-gray-800">
            <h1 class="text-lg font-bold mb-3 text-white flex items-center gap-2">
                <span class="text-indigo-500">â–</span> PPT è½¬ å°çº¢ä¹¦å°é¢
            </h1>
            <label class="group flex items-center justify-center w-full h-10 px-4 transition bg-gray-700 border border-gray-600 border-dashed rounded cursor-pointer hover:border-indigo-500 hover:bg-gray-600/50">
                <span class="text-xs text-gray-300 group-hover:text-white" v-if="!status.processing">
                    ğŸ“‚ ç‚¹å‡»ä¸Šä¼  PDF
                </span>
                <span class="text-xs text-indigo-400 animate-pulse" v-else>
                    æ­£åœ¨è§£æ P{{ status.current }} / {{ status.total }}...
                </span>
                <input type="file" class="hidden" accept="application/pdf" @change="handleFileUpload" :disabled="status.processing">
            </label>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-3 bg-gray-900/30">
            <div class="flex justify-between items-center mb-2 px-1">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase">ç‚¹å‡»å›¾ç‰‡è‡ªåŠ¨å¡«å…¥ / æ‹–æ‹½</h3>
                <span class="text-[10px] text-gray-500">{{ pdfImages.length }}P</span>
            </div>
            <div class="grid grid-cols-5 gap-1.5">
                <div 
                    v-for="(img, index) in pdfImages" 
                    :key="index"
                    class="bg-white rounded overflow-hidden cursor-pointer hover:ring-1 ring-indigo-500 relative group h-12 w-full"
                    draggable="true"
                    @dragstart="dragStart($event, img)"
                    @click="autoFillSlot(img)"
                    @mouseenter="hoverImage = img"
                    @mouseleave="hoverImage = null"
                >
                    <img :src="img" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 right-0 bg-black/70 text-white text-[8px] px-1 rounded-tl">
                        {{index+1}}
                    </div>
                </div>
            </div>
        </div>

        <div class="h-[55%] bg-gray-800 border-t border-gray-700 overflow-y-auto custom-scroll p-4 space-y-5">
            
            <div>
                <label class="text-[10px] font-bold text-gray-500 mb-2 block uppercase">å¸ƒå±€æ¨¡å¼</label>
                <div class="grid grid-cols-3 gap-1">
                    <button @click="changeLayout('mixed-col')" :class="config.layout==='mixed-col' ? 'bg-indigo-600 text-white border-transparent' : 'bg-gray-700 text-gray-400 border-gray-600 hover:bg-gray-600'" class="p-2 border rounded text-xs transition leading-tight">
                        å·¦9 å³3<br><span class="scale-75 inline-block opacity-70">(1åˆ— vs 1åˆ—)</span>
                    </button>
                    <button @click="changeLayout('col-2')" :class="config.layout==='col-2' ? 'bg-indigo-600 text-white border-transparent' : 'bg-gray-700 text-gray-400 border-gray-600 hover:bg-gray-600'" class="p-2 border rounded text-xs transition leading-tight">
                        å•åˆ— 2å¼ <br><span class="scale-75 inline-block opacity-70">(ä¸Šä¸‹æ‹¼æ¥)</span>
                    </button>
                    <button @click="changeLayout('col-3')" :class="config.layout==='col-3' ? 'bg-indigo-600 text-white border-transparent' : 'bg-gray-700 text-gray-400 border-gray-600 hover:bg-gray-600'" class="p-2 border rounded text-xs transition leading-tight">
                        å•åˆ— 3å¼ <br><span class="scale-75 inline-block opacity-70">(ä¸Šä¸‹æ‹¼æ¥)</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 mb-1 block uppercase">ç”»å¸ƒå°ºå¯¸</label>
                    <select v-model="config.aspectRatio" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-gray-200">
                        <option value="auto">è‡ªé€‚åº” (æ¨è)</option>
                        <option value="16/9">16:9 (å®½å±)</option>
                        <option value="3/4">3:4 (å°çº¢ä¹¦)</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 mb-1 block uppercase">å›¾ç‰‡å¡«å……</label>
                    <select v-model="config.objectFit" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-gray-200">
                        <option value="contain">å®Œæ•´å±•ç¤º (ä¸è£åˆ‡)</option>
                        <option value="cover">å¡«æ»¡æ ¼å­ (è£åˆ‡)</option>
                    </select>
                </div>
            </div>

            <div class="bg-gray-700/30 p-2 rounded border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">æ ‡é¢˜åŒºåŸŸ</label>
                    <div class="flex items-center">
                        <input type="checkbox" id="toggleTitle" v-model="config.showTitleHeader" class="mr-1.5 accent-indigo-500 h-3 w-3">
                        <label for="toggleTitle" class="text-xs text-gray-300 cursor-pointer select-none">å¯ç”¨</label>
                    </div>
                </div>
                
                <div v-if="config.showTitleHeader" class="space-y-2">
                    <input type="text" v-model="config.title" placeholder="ä¸»æ ‡é¢˜" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white placeholder-gray-500 focus:border-indigo-500 outline-none">
                    <input type="text" v-model="config.subtitle" placeholder="å‰¯æ ‡é¢˜" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white placeholder-gray-500 focus:border-indigo-500 outline-none">
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex items-center text-xs text-gray-400">
                    <span class="w-10">è¾¹è·</span>
                    <input type="range" v-model.number="config.padding" min="0" max="60" class="flex-1 h-1 bg-gray-600 rounded-lg appearance-none">
                </div>
                <div class="flex items-center text-xs text-gray-400">
                    <span class="w-10">é—´éš”</span>
                    <input type="range" v-model.number="config.gap" min="0" max="40" class="flex-1 h-1 bg-gray-600 rounded-lg appearance-none">
                </div>
                <div class="flex items-center text-xs text-gray-400">
                    <span class="w-10">èƒŒæ™¯</span>
                    <input type="color" v-model="config.bgColor" class="w-6 h-6 rounded border-0 p-0 bg-transparent cursor-pointer mr-2">
                    <span class="text-[10px] opacity-50">(ç”Ÿæˆæ—¶èƒŒæ™¯ä¸é€æ˜)</span>
                </div>
            </div>

            <div class="pt-2">
                <button @click="downloadImage" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2.5 px-4 rounded transition shadow-lg text-sm flex items-center justify-center gap-2">
                    <span>âœ¨ å¯¼å‡ºçº¯å‡€å›¾ç‰‡</span>
                    <select v-model="config.exportScale" @click.stop class="bg-indigo-700 text-white text-[10px] rounded px-1 py-0.5 border-none outline-none cursor-pointer">
                        <option value="2">2x (é«˜æ¸…)</option>
                        <option value="3">3x (è¶…æ¸…)</option>
                    </select>
                </button>
            </div>
            
            <div class="text-center">
                 <button @click="clearAllSlots" class="text-xs text-red-400 hover:text-red-300 underline">æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡</button>
            </div>
        </div>
    </div>

    <div class="flex-1 bg-[#e5e5e5] flex items-center justify-center p-8 overflow-auto relative bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPjxyZWN0IHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMCAwTDggOFpNOCAwTDAgOFoiIHN0cm9rZT0iI2YyZjJmMiIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9zdmc+')]">
        
        <div 
            id="canvas-area"
            :class="{ 'exporting': isExporting }" 
            class="bg-white shadow-2xl transition-all duration-300 flex flex-col box-border"
            :style="canvasStyle"
        >
            <div v-if="config.showTitleHeader" class="mb-4 text-center shrink-0 px-4">
                <h1 v-if="config.title" class="text-2xl font-bold tracking-wide text-gray-800">{{ config.title }}</h1>
                <p v-if="config.subtitle" class="text-sm opacity-60 mt-1 text-gray-600">{{ config.subtitle }}</p>
            </div>

            <div class="flex-1 w-full h-full relative min-h-0">
                
                <div v-if="config.layout === 'mixed-col'" class="grid grid-cols-[1fr_3fr] h-full w-full min-h-0" :style="{ gap: config.gap + 'px' }">
                    <div class="grid grid-cols-1 grid-rows-9 h-full min-h-0" :style="{ gap: config.gap + 'px' }">
                        <div v-for="i in 9" :key="'L'+i" 
                             class="drop-zone border border-dashed border-gray-300 relative group overflow-hidden flex items-center justify-center bg-transparent"
                             :style="{ borderRadius: config.radius + 'px' }"
                             @dragover.prevent @drop="handleDrop($event, i-1)" @dragenter="dragEnter" @dragleave="dragLeave">
                             
                            <div v-if="gridData[i-1]" class="w-full h-full relative flex items-center justify-center overflow-hidden">
                                <img :src="gridData[i-1]" class="max-w-full max-h-full block" :style="{ objectFit: config.objectFit, width: config.objectFit==='cover'?'100%':'auto', height: config.objectFit==='cover'?'100%':'auto' }">
                                <button @click="clearSlot(i-1)" class="delete-btn absolute top-0.5 right-0.5 bg-red-500 text-white rounded w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 z-10">Ã—</button>
                            </div>
                            <span v-else class="slot-number text-gray-300 text-[10px] select-none pointer-events-none">{{i}}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 grid-rows-3 h-full min-h-0" :style="{ gap: config.gap + 'px' }">
                        <div v-for="i in 3" :key="'R'+i" 
                             class="drop-zone border border-dashed border-gray-300 relative group overflow-hidden flex items-center justify-center bg-transparent"
                             :style="{ borderRadius: config.radius + 'px' }"
                             @dragover.prevent @drop="handleDrop($event, 9 + i-1)" @dragenter="dragEnter" @dragleave="dragLeave">
                             
                            <div v-if="gridData[9+i-1]" class="w-full h-full relative flex items-center justify-center overflow-hidden">
                                <img :src="gridData[9+i-1]" class="max-w-full max-h-full block" :style="{ objectFit: config.objectFit, width: config.objectFit==='cover'?'100%':'auto', height: config.objectFit==='cover'?'100%':'auto' }">
                                <button @click="clearSlot(9+i-1)" class="delete-btn absolute top-1 right-1 bg-red-500 text-white rounded w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 z-10">Ã—</button>
                            </div>
                            <span v-else class="slot-number text-gray-300 text-xs select-none pointer-events-none">é‡ç‚¹{{i}}</span>
                        </div>
                    </div>
                </div>

                <div v-else class="grid w-full h-full grid-cols-1 min-h-0" 
                     :class="config.layout === 'col-2' ? 'grid-rows-2' : 'grid-rows-3'"
                     :style="{ gap: config.gap + 'px' }">
                     
                     <div v-for="i in (config.layout === 'col-2' ? 2 : 3)" :key="'S'+i" 
                          class="drop-zone border border-dashed border-gray-300 relative group overflow-hidden flex items-center justify-center bg-transparent"
                          :style="{ borderRadius: config.radius + 'px' }"
                          @dragover.prevent @drop="handleDrop($event, i-1)" @dragenter="dragEnter" @dragleave="dragLeave">
                         
                         <div v-if="gridData[i-1]" class="w-full h-full relative flex items-center justify-center overflow-hidden">
                             <img :src="gridData[i-1]" class="max-w-full max-h-full block" :style="{ objectFit: config.objectFit, width: config.objectFit==='cover'?'100%':'auto', height: config.objectFit==='cover'?'100%':'auto' }">
                             <button @click="clearSlot(i-1)" class="delete-btn absolute top-1 right-1 bg-red-500 text-white rounded w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 z-10">Ã—</button>
                         </div>
                         <span v-else class="slot-number text-gray-300 text-xs select-none pointer-events-none">å›¾{{i}}</span>
                     </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, reactive, nextTick } = Vue;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    createApp({
        setup() {
            const status = reactive({ processing: false, current: 0, total: 0 });
            const isExporting = ref(false);
            const pdfImages = ref([]);
            const hoverImage = ref(null); // æ‚¬åœæ—¶çš„å›¾ç‰‡
            
            // æ ¼å­æ•°æ®ï¼šæ ¹æ®æœ€å¤§å¯èƒ½çš„æ ¼å­æ•°ï¼ˆ9+3=12ï¼‰åˆå§‹åŒ–
            const gridData = ref(new Array(12).fill(null));
            
            const config = reactive({
                layout: 'mixed-col', 
                aspectRatio: 'auto', 
                padding: 20,
                gap: 8,
                radius: 0,
                bgColor: '#ffffff',
                showTitleHeader: false,
                title: 'PPT æ¦‚è§ˆ',
                subtitle: '',
                objectFit: 'contain', 
                exportScale: '2'
            });

            // è·å–å½“å‰å¸ƒå±€éœ€è¦çš„æ ¼å­æ•°é‡
            const currentSlotCount = computed(() => {
                if (config.layout === 'mixed-col') return 12; // 9 + 3
                if (config.layout === 'col-2') return 2;
                if (config.layout === 'col-3') return 3;
                return 12;
            });

            // ç‚¹å‡»å›¾ç‰‡è‡ªåŠ¨å¡«å…¥ç©ºä½
            const autoFillSlot = (imgData) => {
                const maxSlots = currentSlotCount.value;
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ˜¯ null çš„ç´¢å¼•
                const emptyIndex = gridData.value.findIndex((val, idx) => val === null && idx < maxSlots);
                
                if (emptyIndex !== -1) {
                    gridData.value[emptyIndex] = imgData;
                } else {
                    // å¦‚æœæ»¡äº†ï¼Œå¯ä»¥é€‰æ‹©æ›¿æ¢æœ€åä¸€ä¸ªï¼Œæˆ–è€…ä¸åšæ“ä½œã€‚è¿™é‡Œä¸åšæ“ä½œã€‚
                    // alert("å½“å‰å¸ƒå±€æ ¼å­å·²æ»¡ï¼Œè¯·ç‚¹å‡»æ ¼å­å³ä¸Šè§’åˆ é™¤åå†æ·»åŠ ");
                }
            };

            const canvasStyle = computed(() => {
                const style = {
                    padding: `${config.padding}px`,
                    backgroundColor: config.bgColor,
                };
                
                if (config.aspectRatio === 'auto') {
                    style.width = '600px'; 
                    style.height = 'auto'; 
                    style.minHeight = '600px';
                } else {
                    const [w, h] = config.aspectRatio.split('/');
                    style.aspectRatio = `${w} / ${h}`;
                    style.height = '90%'; 
                    style.width = 'auto';
                }
                return style;
            });

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                status.processing = true;
                status.current = 0;
                pdfImages.value = [];
                // ä¸Šä¼ æ—¶ä¸è‡ªåŠ¨æ¸…ç©ºï¼Œé˜²æ­¢ç”¨æˆ·è¯¯æ“ä½œï¼Ÿæˆ–è€…æ¸…ç©ºï¼Œæ ¹æ®ä¹ æƒ¯ã€‚è¿™é‡Œä¸æ¸…ç©ºã€‚
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    status.total = pdf.numPages;

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 2.0 }); 
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        pdfImages.value.push(canvas.toDataURL('image/jpeg', 0.9));
                        status.current = i;
                    }
                } catch (err) {
                    alert("æ–‡ä»¶è§£æå‡ºé”™: " + err.message);
                } finally {
                    status.processing = false;
                }
            };

            const dragStart = (e, imgData) => {
                e.dataTransfer.effectAllowed = "copy";
                e.dataTransfer.setData('text/plain', imgData);
            };

            const dragEnter = (e) => {
                const zone = e.target.closest('.drop-zone');
                if(zone) zone.classList.add('drag-over');
            };

            const dragLeave = (e) => {
                const zone = e.target.closest('.drop-zone');
                if(zone) zone.classList.remove('drag-over');
            };

            const handleDrop = (e, index) => {
                const zone = e.target.closest('.drop-zone');
                if(zone) zone.classList.remove('drag-over');
                const imgData = e.dataTransfer.getData('text/plain');
                if (imgData) gridData.value[index] = imgData;
            };

            const clearSlot = (index) => {
                gridData.value[index] = null;
            };

            const clearAllSlots = () => {
                gridData.value = new Array(12).fill(null);
            }

            const changeLayout = (newLayout) => {
                config.layout = newLayout;
                // åˆ‡æ¢å¸ƒå±€æ—¶ï¼Œä¸ä¿ç•™ä¹‹å‰çš„æ•°æ®ï¼Œæˆ–è€…ä¿ç•™ï¼Ÿä¸ºäº†ä½“éªŒæ›´å¥½ï¼Œä¿ç•™æ•°æ®
                // ä½†å¦‚æœä» 12 åˆ‡åˆ° 2ï¼Œåªæœ‰å‰2ä¸ªä¼šæ˜¾ç¤ºã€‚
            };

            const downloadImage = async () => {
                const element = document.getElementById('canvas-area');
                
                // 1. è¿›å…¥å¯¼å‡ºæ¨¡å¼ï¼ˆCSS ä¼šéšè—è™šçº¿ã€åˆ é™¤æŒ‰é’®ã€åºå·ï¼‰
                isExporting.value = true;
                
                // ç­‰å¾… Vue æ›´æ–° DOM
                await nextTick();

                // ç§»é™¤é˜´å½±ä»¥ä¾¿æˆªå›¾çº¯å‡€
                const originalShadow = element.style.boxShadow;
                element.style.boxShadow = 'none';

                html2canvas(element, {
                    scale: parseInt(config.exportScale),
                    useCORS: true,
                    backgroundColor: null, // é€æ˜èƒŒæ™¯
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ppt-collage-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // æ¢å¤çŠ¶æ€
                    element.style.boxShadow = originalShadow;
                    isExporting.value = false;
                });
            };

            return {
                status, pdfImages, gridData, config, canvasStyle, isExporting, hoverImage,
                handleFileUpload, dragStart, dragEnter, dragLeave, handleDrop, 
                clearSlot, clearAllSlots, autoFillSlot, changeLayout, downloadImage,
                currentSlotCount
            };
        }
    }).mount('#app');
</script>
</body>
</html>
