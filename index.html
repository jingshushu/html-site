<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPT 转 小红书封面 (最终专业版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        [v-cloak] { display: none; }
        
        /* 滚动条细化 */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        /* 导出时隐藏虚线边框的关键样式 */
        .exporting .drop-zone { border: none !important; background: transparent !important; }
        .exporting .slot-number { display: none !important; }
        .exporting .delete-btn { display: none !important; }

        /* 悬停放大预览动画 */
        .zoom-preview {
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            transition: opacity 0.2s;
        }
    </style>
</head>
<body class="bg-gray-900 h-screen overflow-hidden text-gray-200">

<div id="app" v-cloak class="flex h-full">

    <div v-if="hoverImage" class="zoom-preview fixed bottom-4 left-4 border-2 border-indigo-500 bg-gray-800 rounded-lg p-1 w-64 aspect-video">
        <img :src="hoverImage" class="w-full h-full object-contain">
        <div class="absolute top-0 right-0 bg-indigo-600 text-white text-xs px-2 py-0.5">预览</div>
    </div>

    <div class="w-[400px] bg-gray-800 border-r border-gray-700 flex flex-col h-full shadow-lg">
        <div class="flex-none p-4 border-b border-gray-700 relative">
            <input type="file" id="pdfFile" ref="fileInput" accept="application/pdf" class="hidden" @change="loadPdf" />
            <label for="pdfFile" class="cursor-pointer inline-flex items-center bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md shadow-sm text-sm">
                上传PDF
            </label>
            <button @click="downloadAll" class="ml-3 inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md shadow-sm text-sm">
                下载全部
            </button>
            <button @click="exportToHtml" class="ml-3 inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md shadow-sm text-sm">
                转换为小红书版式
            </button>
        </div>
        <div class="flex-1 p-4 overflow-auto custom-scroll">
            <div v-for="(page, index) in pdfImages" :key="index" class="relative border border-gray-700 rounded-lg mt-4 drop-zone" :class="{'border-dashed border-indigo-500': !page.image}" @dragover.prevent="onDragOver" @dragleave.prevent="onDragLeave" @drop.prevent="onDrop($event, index)">
                <div v-if="page.image" class="relative">
                    <img :src="page.image" class="w-full rounded-md">
                    <span class="slot-number absolute top-1 left-1 bg-indigo-500 text-white text-xs px-1 py-0.5 rounded">{{ index + 1 }}</span>
                    <button @click="removeImage(index)" class="delete-btn absolute top-1 right-1 text-white bg-red-600 hover:bg-red-700 rounded px-1 py-0.5 text-xs">X</button>
                </div>
                <div v-else class="flex items-center justify-center w-full h-40 text-gray-500">
                    拖拽图片或上传
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 p-4 overflow-auto custom-scroll relative">
        <div v-if="selectedImage" class="flex justify-center">
            <img :src="selectedImage" ref="previewImage" class="max-h-[calc(100vh-8rem)] object-contain border border-gray-700 rounded-md">
        </div>
        <div v-else class="text-center text-gray-500">请选择页面预览</div>
    </div>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            pdfImages: [],
            hoverImage: null,
            selectedImage: null,
            dragging: false,
            exportMode: false,
        };
    },
    methods: {
        loadPdf(event) {
            const file = event.target.files[0];
            if (!file) return;
            const fileReader = new FileReader();
            fileReader.onload = (e) => {
                const typedarray = new Uint8Array(e.target.result);
                pdfjsLib.getDocument(typedarray).promise.then(async (doc) => {
                    for (let i = 1; i <= doc.numPages; i++) {
                        const page = await doc.getPage(i);
                        const viewport = page.getViewport({ scale: 2 });
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        const renderContext = {
                            canvasContext: canvas.getContext('2d'),
                            viewport: viewport,
                        };
                        await page.render(renderContext).promise;
                        const imgData = canvas.toDataURL('image/png');
                        this.pdfImages.push({ image: imgData });
                    }
                });
            };
            fileReader.readAsArrayBuffer(file);
        },
        onDragOver(event) {
            event.currentTarget.classList.add('border-dashed', 'border-indigo-500');
        },
        onDragLeave(event) {
            event.currentTarget.classList.remove('border-dashed', 'border-indigo-500');
        },
        onDrop(event, index) {
            event.currentTarget.classList.remove('border-dashed', 'border-indigo-500');
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.pdfImages[index].image = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        },
        removeImage(index) {
            this.pdfImages.splice(index, 1);
        },
        downloadAll() {
            this.exportMode = true;
            this.$nextTick(() => {
                const a = document.createElement('a');
                this.pdfImages.forEach((page, idx) => {
                    if (page.image) {
                        a.href = page.image;
                        a.download = `page_${idx + 1}.png`;
                        a.click();
                    }
                });
                this.exportMode = false;
            });
        },
        async exportToHtml() {
            this.exportMode = true;
            this.$nextTick(async () => {
                const htmlParts = [];
                for (let page of this.pdfImages) {
                    if (page.image) {
                        const canvas = await html2canvas(this.$refs.previewImage, { allowTaint: true });
                        const imgData = canvas.toDataURL('image/png');
                        htmlParts.push(`<div style="text-align:center; margin: 20px;"><img src="${imgData}" style="max-width:100%"></div>`);
                    }
                }
                const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>导出HTML</title></head><body>${htmlParts.join('')}</body></html>`;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'export.html';
                a.click();
                URL.revokeObjectURL(url);
                this.exportMode = false;
            });
        },
        selectImage(index) {
            this.selectedImage = this.pdfImages[index].image;
        },
        handleMouseEnter(page) {
            this.hoverImage = page.image;
        },
        handleMouseLeave() {
            this.hoverImage = null;
        },
    },
}).mount('#app');
</script>

</body>
</html>
